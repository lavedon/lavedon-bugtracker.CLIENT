@page "/tickets"
@using Client.Services
@using Client.Models
@attribute [Authorize]
@inject IEntityService EntityService
@inject ILocalStorageService LocalStorage

<PageTitle>List of Tickets</PageTitle>

@if(!string.IsNullOrEmpty(currentUserName))
{
    <h1>Welcome @currentUserName!</h1>
}

<h4>List of Tickets</h4>
<div class="col-md-12 mb-3">
@if (EntityService.Tickets == null)
{
    <h1><em>Loading...</em></h1>
}
else {
<table class="table">
   <thead>
           <th>Ticket Name</th>
           <th>Description</th>
           <th>Project</th>
           <th>Assigned To</th>
           <th>Ticket Created By</th>
   </thead> 
   <tbody>
   @foreach(var ticket in EntityService.Tickets) {
       <tr>
           <td>@ticket.Name</td>
           <td>@ticket.Description</td>
           <td>@ticket.Project.Name</td>
           <td>@ticket.UserAssigned.Username</td>
           <td>@ticket.UserCreated.Username <button class="btn btn-outline-danger btn-sm" title="Delete ticket" @onclick="@(()=>DeleteTicket(ticket))"><span class="oi oi-trash"></span></button></td>
       </tr>
   }
    </tbody>
</table>
}
</div>
<button class="btn btn-primary" @onclick="EntityService.GetUsers">Refresh List of Tickets</button>

@code {
    private string currentUserName = string.Empty;

    private async Task DeleteTicket(TicketDTO ticket)
    {
        await EntityService.DeleteTicket(ticket.Id);
        await EntityService.GetTickets();
        StateHasChanged();
    }
    protected async override void OnInitialized() 
    {
        currentUserName = await LocalStorage.GetItemAsync<string>("usernameFromClaims");
        await this.EntityService.GetTickets();
        StateHasChanged();
    }
}